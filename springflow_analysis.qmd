---
title: "Draft1"
format: html
---

### Setup & Context

The USGS operates over 500 streamgages in Texas aloneâ€“ each measuring the amount of water flowing through their respective streams approximately every 15 minutes and performing several computational analyses to calculate the springflow and streamflow. Springflow is solely the amount of water entering the stream system from the groundwater below via springs or seeps, while streamflow includes the springflow and any additional water added to the system from surface-water runoff during precipitation events. Since it is impractical for a gage to continuously measure streamflow discharge, each gage instead measures the water level, also referred to as gage height, and utilizes the strong mathematical relation between gage height and discharge to continuously calculate streamflow. In order to measure gage height, many USGS streamgages use gas-purge (bubbler) systems to calculate the water level based on the amount of pressure required to push gas out of the underwater tube. With high or increasing water levels more pressure is required to power the bubbler, whereas less gas is required during periods of lowered water levels.

Since springflow cannot be measured directly due to the complicating runoff factor, the USGS uses a computer program to interpolate springflow based on streamflow. This method assumes that springflow is relatively constant, only significantly changing with variable hydrologic conditions of the contributing regional aquifer (decreasing aquifer levels due to drought, for example, would cause a decrease in regional springflow). When surface water runoff from precipitation events contributes to streamflow, another computation is required to separate the streamflow measurement into its contributing parts: surface runoff and springflow. The computation essentially creates a smooth connection between springflow before and after the storm, when springflow and streamflow should be equal. All of these calculations are subject to a series of quality-control checks to ensure that the estimations are plausible and accurate given the coinciding hydrologic and weather conditions before publication.

### dataRetrieval with NWIS data

```{r}
#Steps 4-5, reading and combining all 6 gages into one tibble
'smr'<-readNWISdv(siteNumbers = "08170500",
               parameterCd = "00060")
'sms'<-readNWISdv(siteNumbers = "08170000",
               parameterCd = "00060")
'cr'<-readNWISdv(siteNumbers = "08169000",
                 parameterCd = "00060")
'cs'<-readNWISdv(siteNumbers = "08168710",
                 parameterCd = "00060")
'crnc'<-readNWISdv(siteNumbers = "08168932",
                 parameterCd = "00060")
'croc'<-readNWISdv(siteNumbers = "08168913",
                 parameterCd = "00060")
df<-bind_rows(smr,sms,cr,cs,crnc,croc)|>
  renameNWISColumns('df')
df
```

```{r}
#Steps 6-8, fixing column titles and adding new columns
library("tidyverse")
library("readr")
gages<-as_tibble(df)|>
  select(site_no:Flow)|>
  mutate(
    Year = year(Date),
    Month = month(Date),
    Day = day(Date))|>
  mutate(
    gage_name = case_when(site_no=="08170500"~"San Marcos River",
              site_no=="08170000"~"San Marcos Springs",
              site_no=="08169000"~"Comal River",
              site_no=="08168710"~"Comal Springs",
              site_no=="08168932"~"Comal New Channel",
              site_no=="08168913"~"Comal Old Channel"
              ))|>
  relocate(gage_name,.before=Date)|>
  rename(gage_number=site_no,
         cfs=Flow)

#write_csv(gages,"springflow_master.csv")
```

### Analysis Tibbles

```{r}
#4 high flow days
high_flow_days_300<-tibble(
  filter(gages, cfs>300))
```

```{r}
#7 zero flow days by days by gage
zero_flow_days<-tibble(
  filter(gages, cfs==0))
```

```{r}
#2 median monthly flow per gage
by_gage_month <- gages|>
  group_by(gage_name,Month)|>
  summarise(flow_mean = mean(cfs,na.rm=TRUE))
by_gage_month
```

```{r}
#mean flow by gage and year
mean_flow_gage_year <- gages |>
#could add something in here to exclude comal new/old channels
  group_by(gage_name,Year)|>
  summarise(mean_flow = mean(cfs,na.rm=TRUE))|>
  ungroup()
mean_flow_gage_year
```

```{r}
#5, highest median flow by month_day

# group_by (gage, month, day)
# summarise (median)
# ungroup()
# group_by (gage)
# arrange(desc())
# slice()
# ungroup()

peak_monthday_flows <-gages|>
  group_by(gage_name,Month,Day)|>
  summarise(median_flow = median(cfs,na.rm=TRUE))|>
  ungroup()|>
  group_by(gage_name)|>
  arrange(desc(median_flow))|>
  slice(1:1)|>
  ungroup()
peak_monthday_flows
```
